From 046b3baccb8d0a14af3828ab4cd37c022dc015be Mon Sep 17 00:00:00 2001
From: Veronika Hanulikova <xhanulik@fi.muni.cz>
Date: Fri, 10 Feb 2023 11:47:34 +0100
Subject: [PATCH 02/19] Check array bounds

Thanks OSS-Fuzz
https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=54312

CVE: CVE-2023-40661
Upstream-Status: Backport [df5a176bfdf8c52ba89c7fef1f82f6f3b9312bc1]

Signed-off-by: Changqing Li <changqing.li@windriver.com>
---
 src/libopensc/muscle.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/libopensc/muscle.c b/src/libopensc/muscle.c
index 7af279a0..a749657d 100644
--- a/src/libopensc/muscle.c
+++ b/src/libopensc/muscle.c
@@ -181,6 +181,9 @@ int msc_partial_update_object(sc_card_t *card, msc_id objectId, int offset, cons
 	sc_apdu_t apdu;
 	int r;
 
+	if (dataLength + 9 > MSC_MAX_APDU)
+		return SC_ERROR_INVALID_ARGUMENTS;
+
 	sc_format_apdu(card, &apdu, SC_APDU_CASE_3_SHORT, 0x54, 0x00, 0x00);
 	apdu.lc = dataLength + 9;
 	if (card->ctx->debug >= 2)
-- 
2.25.1

