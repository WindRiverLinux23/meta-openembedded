From f7ad3006ee9c65751b821460f4b2dd9239b89230 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Veronika=20Hanul=C3=ADkov=C3=A1?= <vhanulik@redhat.com>
Date: Thu, 10 Aug 2023 13:44:49 +0200
Subject: [PATCH 09/19] pkcs15-setcos.c: Free file in case of error

Thanks OSS-Fuzz
https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=6067

CVE: CVE-2023-40661
Upstream-Status: Backport [ aa4b47e33c43716877b8fa6e671125530d5b12ec ]

Signed-off-by: Changqing Li <changqing.li@windriver.com>
---
 src/pkcs15init/pkcs15-setcos.c | 15 +++++++++------
 1 file changed, 9 insertions(+), 6 deletions(-)

diff --git a/src/pkcs15init/pkcs15-setcos.c b/src/pkcs15init/pkcs15-setcos.c
index 52b234fa..49c4d233 100644
--- a/src/pkcs15init/pkcs15-setcos.c
+++ b/src/pkcs15init/pkcs15-setcos.c
@@ -348,20 +348,23 @@ setcos_create_key(sc_profile_t *profile, sc_pkcs15_card_t *p15card,
 		file->size = 512;
 
 	/* Replace the path of instantiated key template by the path from the object data. */
-        memcpy(&file->path, &key_info->path, sizeof(file->path));
-        file->id = file->path.value[file->path.len - 2] * 0x100
-		+ file->path.value[file->path.len - 1];
+	memcpy(&file->path, &key_info->path, sizeof(file->path));
+	file->id = file->path.value[file->path.len - 2] * 0x100
+	+ file->path.value[file->path.len - 1];
 
 	key_info->key_reference = file->path.value[file->path.len - 1] & 0xFF;
 
-        sc_log(ctx,  "Path of private key file to create %s\n", sc_print_path(&file->path));
+	sc_log(ctx,  "Path of private key file to create %s\n", sc_print_path(&file->path));
 
-        r = sc_select_file(p15card->card, &file->path, NULL);
-        if (!r)   {
+	r = sc_select_file(p15card->card, &file->path, NULL);
+	if (!r)   {
 		r = sc_pkcs15init_delete_by_path(profile, p15card, &file->path);
+		if (r != SC_SUCCESS)
+			sc_file_free(file);
 		LOG_TEST_RET(ctx, r, "Failed to delete private key file");
 	}
         else if (r != SC_ERROR_FILE_NOT_FOUND)    {
+		sc_file_free(file);
 		LOG_TEST_RET(ctx, r, "Select private key file error");
 	}
 
-- 
2.25.1

