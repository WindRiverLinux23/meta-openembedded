From 984bd96e64f72c8a95b221cea68092298e40f87e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Veronika=20Hanul=C3=ADkov=C3=A1?= <vhanulik@redhat.com>
Date: Thu, 10 Aug 2023 12:20:33 +0200
Subject: [PATCH 07/19] pkcs15-pubkey.c: Avoid double-free

Thanks OSS-Fuzz
https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=60616

CVE: CVE-2023-40661
Upstream-Status: Backport [ 638a5007a5d240d6fa901aa822cfeef94fe36e85 ]

Signed-off-by: Changqing Li <changqing.li@windriver.com>
---
 src/libopensc/pkcs15-pubkey.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/src/libopensc/pkcs15-pubkey.c b/src/libopensc/pkcs15-pubkey.c
index ee4ee462..bc5fa450 100644
--- a/src/libopensc/pkcs15-pubkey.c
+++ b/src/libopensc/pkcs15-pubkey.c
@@ -351,6 +351,12 @@ int sc_pkcs15_decode_pukdf_entry(struct sc_pkcs15_card *p15card,
 err:
 	if (r < 0) {
 		sc_pkcs15_free_pubkey_info(info);
+		if (der->len) {
+			free(der->value);
+			/* der points to obj->content */
+			obj->content.value = NULL;
+			obj->content.len = 0;
+		}
 	}
 
 	LOG_FUNC_RETURN(ctx, r);
-- 
2.25.1

